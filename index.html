<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://unpkg.com/jspdf-font-roboto@1.1.0/dist/roboto.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <title>LCNB - BBBG</title>
    <style>
      :root {
        --gap: 12px;
        --bg: #f6f8fa;
        --card: #fff;
      }
      body {
        margin: 0;
        font-family: Inter, Segoe UI, Arial, sans-serif;
        background: var(--bg);
        height: 100vh;
        display: flex;
      }
      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--gap);
        padding: 16px;
        width: 100%;
      }
      .card {
        background: var(--card);
        border-radius: 10px;
        box-shadow: 0 6px 18px rgba(20, 30, 40, 0.06);
        padding: 16px;
        display: flex;
        flex-direction: column;
      }
      .left {
        min-height: 0;
      } /* allow flexbox to shrink */
      .video-wrap {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        background: #111;
        color: #fff;
        overflow: hidden;
        position: relative;
      }
      video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 12px;
      }
      button {
        background: #0b74ff;
        color: #fff;
        border: 0;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
      }
      button.secondary {
        background: #6b7280;
      }
      select,
      input[type="text"] {
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }
      .right {
        min-height: 0;
      }
      h3 {
        margin: 0 0 8px 0;
      }
      ul.list {
        list-style: none;
        padding: 0;
        margin: 0;
        overflow: auto;
      }
      ul.list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        border-bottom: 1px solid #f1f1f1;
      }
      .code {
        font-family: monospace;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
      }
      .pdf-preview {
        border: 1px dashed #ddd;
        padding: 8px;
        border-radius: 6px;
        margin-top: 10px;
        background: #fff;
      }
      .empty {
        opacity: 0.6;
      }
      .actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }
      @media (max-width: 800px) {
        .container {
          grid-template-columns: 1fr;
          grid-auto-rows: 1fr;
        }
      }
      .header {
        text-align: center;
        margin-bottom: 20px;
      }
      .header img {
        width: 100px;
        height: auto;
        margin-bottom: 5px;
      }
      .header h3 {
        margin: 5px 0;
      }
      .tables {
        display: flex;
        justify-content: center;
        gap: 20px;
        text-align: center;
      }
      table.data {
        border-collapse: collapse;
        width: 48%;
        font-size: 12px;
      }
      th,
      td {
        border: 1px solid #333;
        padding: 5px;
        text-align: center;
      }
      .footer {
        margin-top: 50px;
        display: flex;
        justify-content: space-around;
        font-weight: bold;
      }
      h2 {
        margin-top: 10px;
        margin-bottom: 10px;
      }
      .textr {
        padding-top: 10px;
      }
      #interactive {
  position: relative;
  width: 100%;
  max-width: 600px;
  aspect-ratio: 4 / 3; /* hoặc 16 / 9 tùy camera */
  margin: 0 auto;
  overflow: hidden;
  background: #000;
  border-radius: 8px;
}

#interactive video,
#interactive canvas {
  width: 100%;
  height: 100%;
  object-fit: cover; /* giúp hình ảnh camera lấp đầy khung */
}

    </style>
  </head>
  <body>
    <div class="container">
      <div class="card left">
        <h3>Quét Barcode</h3>
        <div class="video-wrap" id="videoWrap">
          <div id="videoPlaceholder" style="text-align: center; padding: 16px">
            <p style="margin: 0">Nhấn <strong>Mở Camera</strong> để bắt đầu</p>
          </div>
          <div id="interactive" style="display: none">
            <video id="video" autoplay muted playsinline></video>
          </div>
        </div>

        <div class="controls">
          <select id="cameraSelect"></select>
          <button id="startBtn">Mở Camera</button>
          <button id="stopBtn" class="secondary" disabled>Dừng</button>
          <input id="manualInput" type="text" placeholder="Nhập mã thủ công" />
          <button id="addManual" class="secondary">Thêm</button>
        </div>

        <div style="margin-top: 10px; color: #666; font-size: 13px"></div>
      </div>

      <div class="card right">
        <h3>Danh sách mã quét</h3>
        <div class="toolbar">
          <div style="flex: 1">
            <input
              id="search"
              type="text"
              placeholder="Tìm / lọc mã"
              style="width: 100%"
            />
          </div>
          <button id="clearAll" class="secondary">Xóa tất cả</button>
        </div>

        <ul id="list" class="list">
          <li class="empty">Chưa có mã nào</li>
        </ul>

        <div class="actions">
          <button id="generatePdf">Xuất PDF (Biên bản)</button>
          <button id="downloadCsv" class="secondary">Tải CSV</button>
        </div>

        <div class="pdf-preview" id="pdfPreview" style="display: none">
          <strong>Preview PDF:</strong>
          <div id="previewContent" style="margin-top: 8px"></div>
        </div>
      </div>
    </div>

    <!-- Thư viện Quagga (quét barcode) và jsPDF -->
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script>
      // State
      const scanned = [];
      const listEl = document.getElementById("list");
      const cameraSelect = document.getElementById("cameraSelect");
      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const manualInput = document.getElementById("manualInput");
      const addManual = document.getElementById("addManual");
      const searchInput = document.getElementById("search");
      const clearAll = document.getElementById("clearAll");
      const generatePdf = document.getElementById("generatePdf");
      const downloadCsv = document.getElementById("downloadCsv");
      const preview = document.getElementById("pdfPreview");
      const previewContent = document.getElementById("previewContent");

      // List rendering
      function renderList(filter = "") {
        listEl.innerHTML = "";
        const rows = scanned.filter((s) => s.value.includes(filter));
        if (rows.length === 0) {
          listEl.innerHTML = '<li class="empty">Chưa có mã nào</li>';
          return;
        }
        rows.forEach((item, idx) => {
          const li = document.createElement("li");
          li.innerHTML = `<div><div class="code">${escapeHtml(
            item.value
          )}</div><div style="font-size:12px;color:#666">${new Date(
            item.time
          ).toLocaleString()}</div></div><div style="display:flex;gap:8px"><button data-idx="${idx}" class="del">Xóa</button></div>`;
          listEl.appendChild(li);
        });
        // attach delete handlers
        listEl.querySelectorAll(".del").forEach((btn) =>
          btn.addEventListener("click", (e) => {
            const idx = Number(e.currentTarget.dataset.idx);
            // find in global scanned index
            const item = scanned.filter((s) => s.value.includes(filter))[idx];
            const realIndex = scanned.findIndex(
              (s) => s.time === item.time && s.value === item.value
            );
            if (realIndex > -1) scanned.splice(realIndex, 1);
            renderList(searchInput.value.trim());
          })
        );
      }

      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      // Camera devices
      async function listCameras() {
        cameraSelect.innerHTML = "";
        try {
          const devices = await navigator.mediaDevices.enumerateDevices();
          const cams = devices.filter((d) => d.kind === "videoinput");
          if (cams.length === 0) {
            cameraSelect.innerHTML = "<option>Không có camera</option>";
            return;
          }
          cams.forEach((c) => {
            const opt = document.createElement("option");
            opt.value = c.deviceId;
            opt.textContent = c.label || "Camera " + (cameraSelect.length + 1);
            cameraSelect.appendChild(opt);
          });
        } catch (err) {
          console.warn(err);
          cameraSelect.innerHTML = "<option>Lỗi truy cập camera</option>";
        }
      }

      // Start/stop Quagga
      function startScanner() {
        const deviceId = cameraSelect.value || undefined;
        const constraints = { facingMode: "environment" };
        if (deviceId) constraints.deviceId = { exact: deviceId };

        if (typeof Quagga === "undefined") {
          alert("QuaggaJS chưa được tải. Kiểm tra kết nối internet.");
          return;
        }

        Quagga.init(
          {
            inputStream: {
              name: "Live",
              type: "LiveStream",
              target: document.querySelector("#interactive"),
              constraints: constraints,
            },
            decoder: { readers: ["code_128_reader"] },
            locate: true,
          },
          function (err) {
            if (err) {
              console.error(err);
              alert("Lỗi khởi tạo quét: " + err.message);
              return;
            }
            document.getElementById("interactive").style.display = "block";
            document.getElementById("videoPlaceholder").style.display = "none";
            Quagga.start();
            startBtn.disabled = true;
            stopBtn.disabled = false;
          }
        );

        Quagga.offDetected(onDetected);
        Quagga.onDetected(onDetected);
      }

      function stopScanner() {
        try {
          Quagga.stop();
        } catch (e) {}
        document.getElementById("interactive").style.display = "none";
        document.getElementById("videoPlaceholder").style.display = "block";
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }

      // On detected
      function onDetected(result) {
        try {
          const code = result.codeResult.code;
          // de-bounce: nếu giống với item cuối cùng trong 1s thì bỏ qua
          const now = Date.now();
          const last = scanned.length ? scanned[scanned.length - 1] : null;
          if (last && last.value === code && now - last.time < 1100) return;
          scanned.push({ value: code, time: now });
          renderList(searchInput.value.trim());
          // show preview small
          previewContent.innerText = scanned
            .map((s, i) => `${i + 1}. ${s.value}`)
            .join("\n");
          preview.style.display = "block";
        } catch (e) {
          console.error(e);
        }
      }

      // Manual add
      addManual.addEventListener("click", () => {
        const v = manualInput.value.trim();
        if (!v) return;
        scanned.push({ value: v, time: Date.now() });
        manualInput.value = "";
        renderList(searchInput.value.trim());
      });

      // Start/stop buttons
      startBtn.addEventListener("click", async () => {
        await listCameras();
        startScanner();
      });
      stopBtn.addEventListener("click", () => stopScanner());

      // load cameras initially (if permissions already granted)
      listCameras();

      // search filter
      searchInput.addEventListener("input", () =>
        renderList(searchInput.value.trim())
      );

      // clear all
      clearAll.addEventListener("click", () => {
        if (confirm("Xóa tất cả mã quét?")) {
          scanned.splice(0);
          renderList();
          preview.style.display = "none";
        }
      });

      // CSV download
      downloadCsv.addEventListener("click", () => {
        if (scanned.length === 0) {
          alert("Chưa có mã để tải");
          return;
        }
        const rows = scanned.map(
          (s) => `${s.time},"${s.value.replace(/"/g, '""')}"`
        );
        const csv = "time,value\n" + rows.join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "scanned_codes.csv";
        document.body.appendChild(a);
        a.click();
        a.remove();
      });

      // Generate PDF using jsPDF
      generatePdf.addEventListener("click", async () => {
        if (scanned.length === 0) {
          alert("Chưa có mã để xuất PDF");
          return;
        }

        // Tạo phần HTML hiển thị biên bản
        const reportHtml = `
    <div style="font-family: Arial; padding: 20px; width: 800px;">
      <div class="header">
        <div style="display:flex;text-align: center;justify-content: center;">
          <div>
            <img src="icon.jpg" style="padding-right: 20px;width: 150px;" alt="Logo">
          </div>
          <div>
            <h3>CÔNG TY CỔ PHẦN DƯỢC PHẨM FPT LONG CHÂU</h3>
            <div>Địa chỉ: 379-381 Hai Bà Trưng, P.3, Q.3, TP HCM</div>
            <div class="textr">MST: 0315275368</div>
          </div>
        </div>
        <h2>BIÊN BẢN BÀN GIAO HÀNG</h2>
        <div class="textr">Hôm nay, .............. tháng .............. năm .............. tại Kho Tổng Long Châu.</div>
        <div class="textr">Bên giao hàng ..............................................................................................</div>
        <div class="textr"> - Ông (bà) ...................................................................................................</div>
        <div class="textr">Bên giao hàng ..............................................................................................</div>
        <div class="textr"> - Ông (bà) ...................................................................................................</div>
      </div>

      <table border="1" cellspacing="0" cellpadding="4" style="width:85%; border-collapse:collapse;margin-left:85px">
        <thead>
          <tr style="background:#f2f2f2;">
            <th>STT</th>
            <th>SỐ CHỨNG TỪ</th>
            <th>SỐ LƯỢNG</th>
            <th>ĐƠN VỊ TÍNH</th>
          </tr>
        </thead>
        <tbody>
          ${scanned
            .map(
              (s, i) => `
            <tr>
              <td>${i + 1}</td>
              <td>${s.value}</td>
              <td>1</td>
              <td>Thùng</td>
            </tr>
          `
            )
            .join("")}
        </tbody>
      </table>
            <div style="margin-left:85px" class="textr">Biên bản này được lập thành 02 bản và có giá trị pháp lý như nhau: </div>
      <div class="footer">
        <div>BÊN GIAO HÀNG</div>
        <div>BÊN NHẬN HÀNG</div>
      </div>
    </div>
  `;

        const temp = document.createElement("div");
        temp.innerHTML = reportHtml;
        document.body.appendChild(temp);

        const canvas = await html2canvas(temp, { scale: 2 });
        const imgData = canvas.toDataURL("image/png");
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("p", "pt", "a4");

        const pageWidth = pdf.internal.pageSize.getWidth();
        const imgWidth = pageWidth;
        const imgHeight = canvas.height * (imgWidth / canvas.width);

        pdf.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);
        pdf.save("bien_ban_ma_quet.pdf");
        temp.remove();
      });
    </script>
  </body>
</html>
